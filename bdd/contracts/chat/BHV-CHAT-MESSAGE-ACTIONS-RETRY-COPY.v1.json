{
  "id": "BHV-CHAT-MESSAGE-ACTIONS-RETRY-COPY",
  "intent": "assistant 消息必须提供复制/分叉/重试三个 icon 操作，user 消息需提供 inline 编辑并重跑入口；编辑最后一条 user 需在当前会话原地重跑，编辑历史 user 需创建分叉会话并重跑；历史 assistant 点击分叉需创建新会话并保留来源信息并自动触发重生成；最后一条 assistant 点击重试需在当前会话执行且不新建会话；重生成阶段必须展示占位文案与动画语义；clipboard 不可用时降级提示可见且不影响会话继续",
  "context": {
    "surface": "sidepanel.chat",
    "messageRole": "assistant",
    "actions": ["copy", "fork_new_chat", "retry_latest", "edit_user_rerun"],
    "uiStyle": "icon-only-with-accessibility-label"
  },
  "steps": [
    "render_assistant_message_with_action_icons",
    "render_user_message_with_edit_rerun_icon",
    "trigger_edit_rerun_from_user_entry_to_open_inline_editor",
    "submit_inline_editor_for_latest_user_rerun_in_same_session",
    "submit_inline_editor_for_historical_user_fork_and_rerun",
    "trigger_copy_action_with_clipboard_write",
    "show_copy_success_or_failure_feedback",
    "trigger_fork_action_from_historical_assistant_entry",
    "create_fork_session_with_source_metadata",
    "auto_regenerate_after_fork_in_new_session",
    "show_regenerate_placeholder_with_busy_state",
    "trigger_retry_action_from_latest_assistant_entry",
    "retry_latest_assistant_in_current_session"
  ],
  "observables": [
    "assistant_message_shows_copy_and_fork_icons",
    "latest_assistant_message_shows_retry_action",
    "historical_assistant_message_has_fork_action",
    "user_message_shows_edit_rerun_icon",
    "edit_rerun_opens_inline_editor_and_focuses_inline_input",
    "edit_latest_user_rerun_keeps_session_count",
    "edit_latest_user_rerun_shows_regenerate_placeholder",
    "edit_historical_user_rerun_creates_fork_session",
    "edit_historical_user_rerun_switches_to_fork_and_shows_placeholder",
    "copy_success_feedback_is_visible",
    "fork_from_history_creates_new_session",
    "fork_session_exposes_source_metadata",
    "fork_session_auto_enters_regenerate_state",
    "regenerate_placeholder_visible_with_text_and_animation",
    "regenerate_placeholder_has_aria_busy_semantics",
    "retry_latest_creates_new_assistant_reply",
    "retry_latest_keeps_session_count",
    "clipboard_failure_shows_degrade_hint_without_interrupting_session"
  ],
  "risk": "medium",
  "allowed_side_effects": [
    "clipboard_write",
    "dom_update(chat_message_action_state)",
    "runtime_session_continue"
  ],
  "proof_requirements": {
    "required_layers": ["unit", "browser-cdp", "e2e"],
    "min_layers": 3
  },
  "degrade_policy": {
    "clipboard_unavailable": {
      "on_trigger": [
        "show_copy_failure_feedback",
        "keep_chat_runtime_available"
      ]
    }
  },
  "rollback_or_compensation": [
    "copy_failure_must_not_block_regenerate",
    "runtime_flow_keeps_existing_session_context"
  ],
  "version": "1.0.0"
}
